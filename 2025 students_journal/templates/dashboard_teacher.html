{% extends 'dashboard_base.html' %}

{% block content %}
  <p>Керувати журналом:</p>

  <!-- Вибір предмета через GET -->
  <form method="GET" action="{{ url_for('dashboard') }}">
    <label for="subject">Предмет:</label>
    <select name="subject" id="subject" required onchange="this.form.submit()">
      <option value="" disabled {% if not selected_subject %}selected{% endif %}>Оберіть предмет</option>
      {% for subject in subjects %}
        <option value="{{ subject }}" {% if subject == selected_subject %}selected{% endif %}>{{ subject }}</option>
      {% endfor %}
    </select>
  </form>

  {% if selected_subject %}
  <!-- Форма додавання оцінки (POST) -->
  <form action="{{ url_for('dashboard') }}" method="POST" style="margin-top: 1em;">
    <input type="hidden" name="subject" value="{{ selected_subject }}">
    <label for="grade">Оцінка:</label>
    <input type="number" id="grade" name="grade" required min="1" max="100" step="1" pattern="\d+" title="Оцінка має бути числом від 1 до 100">
    <label for="student_id">Студент:</label>
    <select name="student_id" id="student_id" required>
      {% for student in students %}
        <option value="{{ student.id }}">{{ student.login }}</option>
      {% endfor %}
    </select>
    <button type="submit" name="add_grade">Додати оцінку</button>
  </form>

  {% if students_grades %}
  <h3>Оцінки студентів за предметом: {{ selected_subject }}</h3>
  <table border="1" cellpadding="8" cellspacing="0" style="border-collapse: collapse; width: 90%; margin-top: 1em;">
    <thead>
      <tr style="background-color: #f2f2f2;">
        <th>Студент</th>
        <th>Оцінки</th>
        <th>Середній бал</th>
        <th>Дії</th>
      </tr>
    </thead>
    <tbody>
      {% for student, grades in students_grades.items() %}
        <tr>
          <td>{{ student }}</td>
          <td>
            {% for grade in grades %}
              <form action="{{ url_for('edit_grade', grade_id=grade.id) }}" method="POST" style="display:inline-block; margin-right: 10px;">
                <input type="number" name="grade" value="{{ grade.grade }}" min="1" max="100" step="1" style="width: 50px;" required>
                <button type="submit">Оновити</button>
              </form>

              <form action="{{ url_for('delete_grade', grade_id=grade.id) }}" method="POST" style="display:inline-block; margin-left: 5px;">
                <!-- Додаємо hidden subject для редіректу -->
                <input type="hidden" name="subject" value="{{ selected_subject }}">
                <button type="submit" onclick="return confirm('Ви впевнені, що хочете видалити цю оцінку?');">Видалити</button>
              </form>
              <br/>
            {% endfor %}
          </td>
          <td>
            {% if average_per_student[student] is not none %}
              {{ average_per_student[student] }}
            {% else %}
              -
            {% endif %}
          </td>
          <td></td> <!-- Для майбутніх дій -->
        </tr>
      {% endfor %}
    </tbody>
  </table>
  {% endif %}
  {% endif %}
{% endblock %}
